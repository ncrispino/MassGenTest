<?xml version="1.0" encoding="UTF-8"?>
<svg id="viz" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 800" width="1400" height="800" role="img" aria-label="Fourier decomposition visualization">
  <title>Fourier Decomposition of a Complex Periodic Wave (7-term Fourier Series)</title>
  <defs>
    <!-- Light scientific grid background -->
    <pattern id="minorGrid" width="20" height="20" patternUnits="userSpaceOnUse">
      <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e8edf5" stroke-width="1"/>
    </pattern>
    <pattern id="majorGrid" width="100" height="100" patternUnits="userSpaceOnUse">
      <rect width="100" height="100" fill="url(#minorGrid)"/>
      <path d="M 100 0 L 0 0 0 100" fill="none" stroke="#d9e2ef" stroke-width="1.2"/>
    </pattern>

    <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="1" stdDeviation="1.5" flood-color="#0f172a" flood-opacity="0.10"/>
    </filter>
  </defs>

  <style><![CDATA[
    :root {
      --fg: #0f172a;
      --muted: #475569;
      --gridMajor: #d9e2ef;
      --gridMinor: #e8edf5;
      --panel: rgba(255,255,255,0.75);
      --panelStroke: rgba(15, 23, 42, 0.10);
    }

    /* CSS-driven time variable (used by the inline JS for path resampling) */
    @property --t {
      syntax: '<number>';
      inherits: true;
      initial-value: 0;
    }

    #viz {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --t: 0;
      animation: timeflow 6s linear infinite;
      background: #f8fafc;
    }

    @keyframes timeflow {
      from { --t: 0; }
      to   { --t: 1; }
    }

    .h1 { font-size: 22px; font-weight: 700; fill: var(--fg); }
    .h2 { font-size: 14px; font-weight: 700; fill: var(--fg); }
    .small { font-size: 12px; fill: var(--muted); }
    .tiny { font-size: 11px; fill: var(--muted); }

    .axis { stroke: rgba(15,23,42,0.55); stroke-width: 1.2; }
    .tick { stroke: rgba(15,23,42,0.25); stroke-width: 1; }

    .panel {
      fill: var(--panel);
      stroke: var(--panelStroke);
      stroke-width: 1;
      filter: url(#softShadow);
    }

    .waveComposite { stroke: #0f172a; stroke-width: 3.0; fill: none; }
    .waveComponent { stroke-width: 2.1; fill: none; opacity: 0.95; }

    .probeLine { stroke: rgba(15,23,42,0.25); stroke-dasharray: 6 6; stroke-width: 1.2; }
    .connector { fill: none; stroke-width: 1.5; stroke-dasharray: 4 6; opacity: 0.25; }

    .dot { stroke: rgba(255,255,255,0.9); stroke-width: 1; }

    .sep { stroke: rgba(15,23,42,0.15); stroke-width: 2; stroke-dasharray: 6 8; }

    .formula {
      font-family: ui-serif, Georgia, "Times New Roman", Times, serif;
      font-size: 16px;
      fill: var(--fg);
    }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  ]]></style>

  <!-- Background -->
  <rect x="0" y="0" width="1400" height="800" fill="url(#majorGrid)"/>

  <!-- Global title -->
  <text x="40" y="44" class="h1">Fourier Decomposition (7 harmonics) — animated, two periods</text>
  <text x="40" y="66" class="small">Left: composite signal. Middle: individual harmonics. Right: magnitude phase spectra.</text>

  <!-- Section separators -->
  <line x1="466" y1="80" x2="466" y2="780" class="sep"/>
  <line x1="933" y1="80" x2="933" y2="780" class="sep"/>

  <!-- LEFT PANEL: composite wave -->
  <g id="leftPanel">
    <rect x="26" y="90" width="420" height="640" rx="14" class="panel"/>
    <text x="46" y="120" class="h2">Composite wave:  x ∈ [0, 2T]</text>
    <text x="46" y="140" class="tiny">f(x) = A₀ + Σₙ₌₁⁷ Aₙ sin(2πn·x/T + φₙ)</text>

    <!-- Plot area geometry (used by JS too, but replicated numerically there) -->
    <!-- Plot frame -->
    <rect x="56" y="170" width="380" height="260" fill="rgba(255,255,255,0.55)" stroke="rgba(15,23,42,0.10)"/>

    <!-- Axes -->
    <line x1="56" y1="300" x2="436" y2="300" class="axis"/>
    <line x1="56" y1="170" x2="56" y2="430" class="axis"/>

    <!-- x ticks: 0, T, 2T -->
    <line x1="56" y1="300" x2="56" y2="306" class="tick"/>
    <line x1="246" y1="300" x2="246" y2="306" class="tick"/>
    <line x1="436" y1="300" x2="436" y2="306" class="tick"/>
    <text x="56" y="324" text-anchor="middle" class="tiny">0</text>
    <text x="246" y="324" text-anchor="middle" class="tiny">T</text>
    <text x="436" y="324" text-anchor="middle" class="tiny">2T</text>

    <!-- y ticks: -2, 0, 2 -->
    <line x1="50" y1="300" x2="56" y2="300" class="tick"/>
    <line x1="50" y1="240" x2="56" y2="240" class="tick"/>
    <line x1="50" y1="360" x2="56" y2="360" class="tick"/>
    <text x="46" y="304" text-anchor="end" class="tiny">0</text>
    <text x="46" y="244" text-anchor="end" class="tiny">+2</text>
    <text x="46" y="364" text-anchor="end" class="tiny">−2</text>

    <text x="436" y="450" text-anchor="end" class="tiny">x</text>
    <text x="36" y="178" text-anchor="start" class="tiny">y</text>

    <!-- Probe line at x = T (used for connector verification) -->
    <line id="probeLineLeft" x1="246" y1="170" x2="246" y2="430" class="probeLine"/>
    <text x="246" y="165" text-anchor="middle" class="tiny">probe</text>

    <!-- Composite wave path (animated via JS resampling) -->
    <path id="compositePath" class="waveComposite" d="M 56 300 L 436 300"/>

    <!-- Partial sums at probe (one per harmonic) -->
    <g id="partialSums">
      <circle id="partialDot1" cx="246" cy="300" r="4" fill="#ef4444" class="dot"/>
      <circle id="partialDot2" cx="246" cy="300" r="4" fill="#f59e0b" class="dot"/>
      <circle id="partialDot3" cx="246" cy="300" r="4" fill="#eab308" class="dot"/>
      <circle id="partialDot4" cx="246" cy="300" r="4" fill="#22c55e" class="dot"/>
      <circle id="partialDot5" cx="246" cy="300" r="4" fill="#3b82f6" class="dot"/>
      <circle id="partialDot6" cx="246" cy="300" r="4" fill="#8b5cf6" class="dot"/>
      <circle id="partialDot7" cx="246" cy="300" r="5" fill="#ec4899" class="dot"/>
      <circle id="compositeProbeDot" cx="246" cy="300" r="6" fill="#0f172a" opacity="0.85"/>
    </g>

    <text x="56" y="478" class="tiny">Colored dots: partial sums at probe after adding each harmonic (1→7).</text>
    <text x="56" y="496" class="tiny">This makes the decomposition visually verifiable during animation.</text>
  </g>

  <!-- MIDDLE PANEL: 7 stacked components -->
  <g id="middlePanel">
    <rect x="486" y="90" width="420" height="640" rx="14" class="panel"/>
    <text x="506" y="120" class="h2">Harmonic components (stacked)</text>
    <text x="506" y="140" class="tiny">Each component oscillates at n·f (phase advances n× faster).</text>

    <!-- Mini-axes rows -->
    <!-- Layout: rows start y=170, rowH=74, gap=14; plot x=540..890 (350px) -->

    <g id="row1">
      <text x="506" y="198" class="tiny">1f   A₁=1.00</text>
      <rect x="540" y="170" width="350" height="74" fill="rgba(255,255,255,0.55)" stroke="rgba(15,23,42,0.10)"/>
      <line x1="540" y1="207" x2="890" y2="207" class="axis"/>
      <path id="compPath1" class="waveComponent" stroke="#ef4444" d="M 540 207 L 890 207"/>
      <circle id="compDot1" cx="715" cy="207" r="4.5" fill="#ef4444" class="dot"/>
    </g>

    <g id="row2">
      <text x="506" y="286" class="tiny">2f   A₂=0.60</text>
      <rect x="540" y="258" width="350" height="74" fill="rgba(255,255,255,0.55)" stroke="rgba(15,23,42,0.10)"/>
      <line x1="540" y1="295" x2="890" y2="295" class="axis"/>
      <path id="compPath2" class="waveComponent" stroke="#f59e0b" d="M 540 295 L 890 295"/>
      <circle id="compDot2" cx="715" cy="295" r="4.5" fill="#f59e0b" class="dot"/>
    </g>

    <g id="row3">
      <text x="506" y="374" class="tiny">3f   A₃=0.35</text>
      <rect x="540" y="346" width="350" height="74" fill="rgba(255,255,255,0.55)" stroke="rgba(15,23,42,0.10)"/>
      <line x1="540" y1="383" x2="890" y2="383" class="axis"/>
      <path id="compPath3" class="waveComponent" stroke="#eab308" d="M 540 383 L 890 383"/>
      <circle id="compDot3" cx="715" cy="383" r="4.5" fill="#eab308" class="dot"/>
    </g>

    <g id="row4">
      <text x="506" y="462" class="tiny">4f   A₄=0.25</text>
      <rect x="540" y="434" width="350" height="74" fill="rgba(255,255,255,0.55)" stroke="rgba(15,23,42,0.10)"/>
      <line x1="540" y1="471" x2="890" y2="471" class="axis"/>
      <path id="compPath4" class="waveComponent" stroke="#22c55e" d="M 540 471 L 890 471"/>
      <circle id="compDot4" cx="715" cy="471" r="4.5" fill="#22c55e" class="dot"/>
    </g>

    <g id="row5">
      <text x="506" y="550" class="tiny">5f   A₅=0.20</text>
      <rect x="540" y="522" width="350" height="74" fill="rgba(255,255,255,0.55)" stroke="rgba(15,23,42,0.10)"/>
      <line x1="540" y1="559" x2="890" y2="559" class="axis"/>
      <path id="compPath5" class="waveComponent" stroke="#3b82f6" d="M 540 559 L 890 559"/>
      <circle id="compDot5" cx="715" cy="559" r="4.5" fill="#3b82f6" class="dot"/>
    </g>

    <g id="row6">
      <text x="506" y="638" class="tiny">6f   A₆=0.18</text>
      <rect x="540" y="610" width="350" height="74" fill="rgba(255,255,255,0.55)" stroke="rgba(15,23,42,0.10)"/>
      <line x1="540" y1="647" x2="890" y2="647" class="axis"/>
      <path id="compPath6" class="waveComponent" stroke="#8b5cf6" d="M 540 647 L 890 647"/>
      <circle id="compDot6" cx="715" cy="647" r="4.5" fill="#8b5cf6" class="dot"/>
    </g>

    <g id="row7">
      <text x="506" y="726" class="tiny">7f   A₇=0.14</text>
      <rect x="540" y="698" width="350" height="74" fill="rgba(255,255,255,0.55)" stroke="rgba(15,23,42,0.10)"/>
      <line x1="540" y1="735" x2="890" y2="735" class="axis"/>
      <path id="compPath7" class="waveComponent" stroke="#ec4899" d="M 540 735 L 890 735"/>
      <circle id="compDot7" cx="715" cy="735" r="4.8" fill="#ec4899" class="dot"/>
    </g>

    <!-- Shared note -->
    <text x="540" y="768" class="tiny" text-anchor="middle">x spans two periods (0→2T), matching the composite plot.</text>
  </g>

  <!-- CONNECTORS overlay (faint) -->
  <g id="connectors">
    <path id="conn1" class="connector" stroke="#ef4444" d="M 715 207 C 610 207 420 220 246 300"/>
    <path id="conn2" class="connector" stroke="#f59e0b" d="M 715 295 C 610 295 420 260 246 300"/>
    <path id="conn3" class="connector" stroke="#eab308" d="M 715 383 C 610 383 420 300 246 300"/>
    <path id="conn4" class="connector" stroke="#22c55e" d="M 715 471 C 610 471 420 340 246 300"/>
    <path id="conn5" class="connector" stroke="#3b82f6" d="M 715 559 C 610 559 420 380 246 300"/>
    <path id="conn6" class="connector" stroke="#8b5cf6" d="M 715 647 C 610 647 420 410 246 300"/>
    <path id="conn7" class="connector" stroke="#ec4899" d="M 715 735 C 610 735 420 430 246 300"/>
  </g>

  <!-- RIGHT PANEL: spectra + formula -->
  <g id="rightPanel">
    <rect x="953" y="90" width="420" height="640" rx="14" class="panel"/>
    <text x="973" y="120" class="h2">Spectra (7 harmonics)</text>

    <!-- Phase spectrum (top) -->
    <text x="973" y="150" class="small">Phase spectrum</text>
    <rect x="973" y="162" width="380" height="180" fill="rgba(255,255,255,0.55)" stroke="rgba(15,23,42,0.10)"/>

    <!-- Phase indicators: circles with hands -->
    <g id="phase" transform="translate(990, 175)">
      <!-- positions spaced 52px; radius 18 -->
      <g transform="translate(0,0)">
        <circle cx="0" cy="0" r="18" fill="none" stroke="#ef4444" stroke-width="2"/>
        <line id="phaseHand1" x1="0" y1="0" x2="16" y2="0" stroke="#ef4444" stroke-width="2" stroke-linecap="round"/>
        <text x="0" y="34" class="tiny" text-anchor="middle">f</text>
      </g>
      <g transform="translate(54,0)">
        <circle cx="0" cy="0" r="18" fill="none" stroke="#f59e0b" stroke-width="2"/>
        <line id="phaseHand2" x1="0" y1="0" x2="12" y2="-10" stroke="#f59e0b" stroke-width="2" stroke-linecap="round"/>
        <text x="0" y="34" class="tiny" text-anchor="middle">2f</text>
      </g>
      <g transform="translate(108,0)">
        <circle cx="0" cy="0" r="18" fill="none" stroke="#eab308" stroke-width="2"/>
        <line id="phaseHand3" x1="0" y1="0" x2="6" y2="-15" stroke="#eab308" stroke-width="2" stroke-linecap="round"/>
        <text x="0" y="34" class="tiny" text-anchor="middle">3f</text>
      </g>
      <g transform="translate(162,0)">
        <circle cx="0" cy="0" r="18" fill="none" stroke="#22c55e" stroke-width="2"/>
        <line id="phaseHand4" x1="0" y1="0" x2="-6" y2="-15" stroke="#22c55e" stroke-width="2" stroke-linecap="round"/>
        <text x="0" y="34" class="tiny" text-anchor="middle">4f</text>
      </g>
      <g transform="translate(216,0)">
        <circle cx="0" cy="0" r="18" fill="none" stroke="#3b82f6" stroke-width="2"/>
        <line id="phaseHand5" x1="0" y1="0" x2="-15" y2="6" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
        <text x="0" y="34" class="tiny" text-anchor="middle">5f</text>
      </g>
      <g transform="translate(270,0)">
        <circle cx="0" cy="0" r="18" fill="none" stroke="#8b5cf6" stroke-width="2"/>
        <line id="phaseHand6" x1="0" y1="0" x2="-12" y2="10" stroke="#8b5cf6" stroke-width="2" stroke-linecap="round"/>
        <text x="0" y="34" class="tiny" text-anchor="middle">6f</text>
      </g>
      <g transform="translate(324,0)">
        <circle cx="0" cy="0" r="18" fill="none" stroke="#ec4899" stroke-width="2"/>
        <line id="phaseHand7" x1="0" y1="0" x2="10" y2="12" stroke="#ec4899" stroke-width="2" stroke-linecap="round"/>
        <text x="0" y="34" class="tiny" text-anchor="middle">7f</text>
      </g>

      <text x="0" y="86" class="tiny mono">φ = [0°, 40°, 70°, 110°, 200°, 240°, 320°]</text>
    </g>

    <!-- Magnitude spectrum (bottom) -->
    <text x="973" y="386" class="small">Magnitude spectrum</text>
    <rect x="973" y="398" width="380" height="220" fill="rgba(255,255,255,0.55)" stroke="rgba(15,23,42,0.10)"/>

    <!-- Axes for magnitude -->
    <line x1="1000" y1="600" x2="1340" y2="600" class="axis"/>
    <line x1="1000" y1="420" x2="1000" y2="600" class="axis"/>
    <text x="1340" y="620" class="tiny" text-anchor="end">frequency</text>
    <text x="988" y="424" class="tiny" text-anchor="end">|Aₙ|</text>

    <!-- Bars (heights proportional to A_n) -->
    <g id="mags">
      <!-- barW=34, gap=14; startX=1020; baseline=600; maxH=160 for A1=1 -->
      <rect x="1020" y="440" width="34" height="160" fill="#ef4444" opacity="0.55" stroke="#ef4444"/>
      <rect x="1068" y="504" width="34" height="96" fill="#f59e0b" opacity="0.55" stroke="#f59e0b"/>
      <rect x="1116" y="544" width="34" height="56" fill="#eab308" opacity="0.55" stroke="#eab308"/>
      <rect x="1164" y="560" width="34" height="40" fill="#22c55e" opacity="0.55" stroke="#22c55e"/>
      <rect x="1212" y="568" width="34" height="32" fill="#3b82f6" opacity="0.55" stroke="#3b82f6"/>
      <rect x="1260" y="571" width="34" height="29" fill="#8b5cf6" opacity="0.55" stroke="#8b5cf6"/>
      <rect x="1308" y="578" width="34" height="22" fill="#ec4899" opacity="0.55" stroke="#ec4899"/>

      <text x="1037" y="640" class="tiny" text-anchor="middle">f</text>
      <text x="1085" y="640" class="tiny" text-anchor="middle">2f</text>
      <text x="1133" y="640" class="tiny" text-anchor="middle">3f</text>
      <text x="1181" y="640" class="tiny" text-anchor="middle">4f</text>
      <text x="1229" y="640" class="tiny" text-anchor="middle">5f</text>
      <text x="1277" y="640" class="tiny" text-anchor="middle">6f</text>
      <text x="1325" y="640" class="tiny" text-anchor="middle">7f</text>
    </g>

    <!-- Fourier series formula -->
    <rect x="973" y="650" width="380" height="70" rx="10" fill="rgba(255,255,255,0.75)" stroke="rgba(15,23,42,0.10)"/>
    <text x="991" y="677" class="formula">f(x,t) = A₀ + Σ<tspan baseline-shift="sub" font-size="12">n=1</tspan><tspan baseline-shift="super" font-size="12">7</tspan> Aₙ sin(2πn·x/T + φₙ + 2πn·t)</text>
    <text x="991" y="700" class="tiny">(In this demo: A₀ = 0.12; t animates 0→1, so harmonic n advances n× per cycle.)</text>
  </g>

  <!-- Inline animation script: resamples sinusoids into path data each frame -->
  <script><![CDATA[
  (function() {
    const svg = document.getElementById('viz');

    // Fourier coefficients (7-term). Chosen to create sharp peaks + flatter regions.
    const A0 = 0.12;
    const A = [1.00, 0.60, 0.35, 0.25, 0.20, 0.18, 0.14];
    const phiDeg = [0, 40, 70, 110, 200, 240, 320];
    const phi = phiDeg.map(d => d * Math.PI / 180);

    const N = 7;

    // Colors are baked into SVG for strokes/fills; kept here only for reference.

    // Geometry (must match the drawing above)
    const left = {
      x: 56,
      y: 170,
      w: 380,
      h: 260,
      yMid: 300,
      yScale: 70,
      xProbe: 246
    };

    const mid = {
      x: 540,
      w: 350,
      yTop: [170, 258, 346, 434, 522, 610, 698],
      h: 74,
      yMid: [207, 295, 383, 471, 559, 647, 735],
      yScale: 25,
      xProbe: 715
    };

    // DOM refs
    const compositePath = document.getElementById('compositePath');
    const compositeProbeDot = document.getElementById('compositeProbeDot');

    const compPaths = Array.from({length: N}, (_, i) => document.getElementById('compPath' + (i+1)));
    const compDots  = Array.from({length: N}, (_, i) => document.getElementById('compDot' + (i+1)));
    const partialDots = Array.from({length: N}, (_, i) => document.getElementById('partialDot' + (i+1)));
    const connPaths = Array.from({length: N}, (_, i) => document.getElementById('conn' + (i+1)));

    // Helper
    const TAU = Math.PI * 2;
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

    function getT() {
      // Prefer CSS-driven typed custom property (smooth + easy to tweak)
      const raw = getComputedStyle(svg).getPropertyValue('--t');
      let t = parseFloat(raw);
      if (!isFinite(t)) {
        // Fallback: time-based
        const periodMs = 6000;
        t = (performance.now() % periodMs) / periodMs;
      }
      return t;
    }

    function buildPath(x0, yMid, w, yScale, valueFn, samples) {
      let d = '';
      for (let i = 0; i < samples; i++) {
        const u = i / (samples - 1);        // u in [0,1]
        const x = x0 + u * w;
        const xNorm = 2 * u;               // two periods: [0,2]
        const theta = TAU * xNorm;         // [0,4π]
        const yVal = valueFn(theta);
        const y = yMid - yScale * yVal;
        d += (i === 0 ? 'M ' : ' L ') + x.toFixed(2) + ' ' + y.toFixed(2);
      }
      return d;
    }

    function frame() {
      const t = getT();
      const timePhase = TAU * t;

      // Composite wave
      const compD = buildPath(left.x, left.yMid, left.w, left.yScale, (theta) => {
        let s = A0;
        for (let n = 1; n <= N; n++) {
          s += A[n-1] * Math.sin(n * (theta + timePhase) + phi[n-1]);
        }
        return s;
      }, 520);
      compositePath.setAttribute('d', compD);

      // Component waves in middle panel
      for (let n = 1; n <= N; n++) {
        const d = buildPath(mid.x, mid.yMid[n-1], mid.w, mid.yScale, (theta) => {
          return A[n-1] * Math.sin(n * (theta + timePhase) + phi[n-1]);
        }, 260);
        compPaths[n-1].setAttribute('d', d);
      }

      // Probe values at x = T => theta = 2π
      const thetaProbe = TAU; // 2π
      let cum = A0;

      // Composite dot (final sum)
      // (computed after loop)

      for (let n = 1; n <= N; n++) {
        const yn = A[n-1] * Math.sin(n * (thetaProbe + timePhase) + phi[n-1]);

        // component dot positions
        const yComp = mid.yMid[n-1] - mid.yScale * yn;
        compDots[n-1].setAttribute('cy', yComp.toFixed(2));

        // partial sum dot positions (on probe line in left panel)
        cum += yn;
        const yPartial = left.yMid - left.yScale * cum;
        partialDots[n-1].setAttribute('cy', yPartial.toFixed(2));

        // connector curve (component dot -> corresponding partial sum dot)
        const x1 = mid.xProbe;
        const y1 = yComp;
        const x2 = left.xProbe;
        const y2 = yPartial;
        const cx1 = x1 - 120;
        const cy1 = y1;
        const cx2 = x2 + 140;
        const cy2 = y2;
        connPaths[n-1].setAttribute('d', `M ${x1.toFixed(2)} ${y1.toFixed(2)} C ${cx1.toFixed(2)} ${cy1.toFixed(2)} ${cx2.toFixed(2)} ${cy2.toFixed(2)} ${x2.toFixed(2)} ${y2.toFixed(2)}`);
      }

      // final composite probe dot
      const yFinal = left.yMid - left.yScale * cum;
      compositeProbeDot.setAttribute('cy', yFinal.toFixed(2));

      requestAnimationFrame(frame);
    }

    // Kick off
    requestAnimationFrame(frame);
  })();
  ]]></script>
</svg>
